/*******************************************************************************
 * Copyright (c) 2016 Gigatronik Ingolstadt GmbH
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 * Sebastian Dirsch - initial configuration
 *******************************************************************************/ 

import org.apache.tools.ant.taskdefs.condition.Os
description = 'MDM Web Application'
version = '1.0.0'
apply plugin: "de.richsource.gradle.plugins.typescript"
apply plugin: 'com.moowork.node'

dependencies {
	compile 'org.glassfish.jersey.containers:jersey-container-servlet:2.15'
	compile 'com.sun.jersey:jersey-json:1.19.1'
	compile project(':org.eclipse.mdm.businessobjects')
}

buildscript {
	repositories { maven { url "https://plugins.gradle.org/m2/" } }

	dependencies { classpath "com.moowork.gradle:gradle-node-plugin:0.12" }
}

buildscript {
	repositories {
		maven { url "https://plugins.gradle.org/m2/" }
	}
	dependencies { classpath "de.richsource.gradle.plugins:typescript-gradle-plugin:1.8.0" }
}


node {
	version = '4.3.2'
	npmVersion = '3.9.2'
	distBaseUrl = 'https://nodejs.org/dist'
	download = true
	workDir = file("${project.buildDir}/nodejs")
	nodeModulesDir = file("${project.buildDir}/nodeModules")
	if (!nodeModulesDir.isDirectory()) {
		nodeModulesDir.mkdirs()
	}
}

task deleteTMPFiles(type: Delete) {
	delete fileTree("${project.buildDir}") { include "nodeModules/*", "ts/*" }
}

task copyFilesToModulesFolder(type: Copy) {
	from '/src/main/webapp/app' , '/src/main/webapp/tsconfig.json', '/src/main/webapp/package.json', '/src/main/webapp/typings.json', '/src/main/webapp/systemjs.config.js'
	into "${project.buildDir}/nodeModules"
}

copyFilesToModulesFolder.dependsOn(deleteTMPFiles)

compileTypeScript.dependsOn(copyFilesToModulesFolder)
compileTypeScript.dependsOn(npmInstall)

compileTypeScript {
	projectFile = new File("${project.buildDir}/nodeModules")
	source = file("${project.buildDir}/nodeModules")
	outputDir = file("${project.buildDir}/app");
	if (Os.isFamily(Os.FAMILY_WINDOWS)) {
		compilerExecutable "${project.buildDir}/nodejs/node-v4.3.2-windows-x64/bin/node.exe ${project.buildDir}/nodeModules/node_modules/typescript/lib/tsc.js"
	} else {
		compilerExecutable "${project.buildDir}/nodejs/node-v4.3.2-linux-x86/bin/node ${project.buildDir}/nodeModules/node_modules/typescript/lib/tsc.js"
	}
}

compileJava.dependsOn(compileTypeScript)

