<!--****************************************************************************
*  Original work: Copyright (c) 2016 Gigatronik Ingolstadt GmbH                *
*  Modified work: Copyright (c) 2017 Peak Solution GmbH                        *
*                                                                              *
*  All rights reserved. This program and the accompanying materials            *
*  are made available under the terms of the Eclipse Public License v1.0       *
*  which accompanies this distribution, and is available at                    *
*  http://www.eclipse.org/legal/epl-v10.html                                   *
*                                                                              *
*  Contributors:                                                               *
*  Dennis Schroeder - initial implementation                                   *
*  Matthias Koller, Johannes Stamm - additional client functionality           *
*****************************************************************************-->

<style>
   :host /deep/ .dropdown {
    width: 200px;
  }

   :host /deep/ .dropdown-toggle {
    overflow: hidden;
    padding-right: 24px/* Optional for caret */
    ;
    text-align: left;
    text-overflow: ellipsis;
    width: 100%;
  }
  /* Optional for caret */

   :host /deep/ .dropdown-toggle .caret {
    position: absolute;
    right: 12px;
    top: calc(50% - 2px);
  }

</style>
<form class="form-inline" style="margin-bottom: 10px; width:100% !important;">
  <div class="form-group">
    <label for="search-source" class="control-label">Filter</label>
    <div class="btn-group" dropdown>
      <button id="search-source" type="button" class="btn btn-default dropdown-toggle" dropdownToggle aria-haspopup="true" aria-expanded="false">
        {{currentFilter.name}} <span class="caret"></span>
      </button>
      <ul class="dropdown-menu" dropdownMenu>
        <li *ngFor="let filter of filters">
          <a class="dropdown-item" (click)="selectFilter(filter)">{{filter.name}}</a>
        </li>
      </ul>
    </div>
  </div>
  <div class="form-group">
    <label for="search-source" class="control-label">Quelle</label>
    <dropdown-multiselect name="envs" [dropdownConfig]="dropdownConfig" [(ngModel)]="dropdownModel" (ngModelChange)="selectedEnvironmentsChanged($event)"></dropdown-multiselect>
  </div>
  <div class="form-group">
    <label for="search-resulttype" class="control-label">Ergebnistyp</label>
    <div class="btn-group" dropdown>
      <button id="search-resulttype" type="button" class="btn btn-default dropdown-toggle" dropdownToggle aria-haspopup="true" aria-expanded="false">
        {{getSearchDefinition(currentFilter.resultType)?.label}} <span class="caret"></span>
      </button>
      <ul class="dropdown-menu" dropdownMenu>
        <li *ngFor="let def of definitions" role="menuitem">
          <a class="dropdown-item" (click)="selectResultType(def)">{{def.label}}</a>
        </li>
      </ul>
    </div>
  </div>
</form>

<div class="row" style="margin-bottom: 10px;">
  <div class="col-lg-2"></div>
  <div class="col-lg-8">
    <div class="input-group input-group">
      <input type="text" class="form-control" name="searchText" placeholder="Suchtext eingeben" [(ngModel)]="currentFilter.fulltextQuery" (keyup.enter)="onSearch()" aria-describedby="basic-addon1" style="width:100%">
      <span class="input-group-btn">
        <button type="button" class="btn btn-default" (click)="onSearch()">Suchen</button>
      </span>
    </div>
  </div>
  <div class="col-lg-2"></div>
</div>

<accordion>

  <accordion-group [isOpen]="true" t="isAdvancedSearchOpen" #advancedSearch [ngClass]="{'greyed': !isBoxChecked}">
    <div accordion-heading class="thinheader">
      <div class="row">
        <div class="col-xs-9">
          <div class="pull-left">
            <input type="checkbox" [(ngModel)]="isBoxChecked" (click)="onCheckBoxClick($event)" /> &nbsp;Advanced search &nbsp;&nbsp;
            <button type="button" class="btn btn-default" (click)="showSearchFieldsEditor($event)" [disabled]=!isBoxChecked><span class="glyphicon glyphicon-plus"></span></button>
            <button type="button" class="btn btn-default" (click)="showSearchFieldsEditor($event,currentFilter.conditions)" [disabled]=!isBoxChecked><span class="glyphicon glyphicon-edit"></span></button>
            <button type="button" class="btn btn-default" (click)="showSaveModal($event)" title="Save search filter" [disabled]=!isBoxChecked><span class="glyphicon glyphicon-floppy-disk"></span></button>
          </div>
        </div>
        <div class="col-xs-3 pull-right">
          <div class="pull-right">
            <button type="button" class="btn btn-default" (click)="resetConditions($event)" title="Reset search conditions" [disabled]=!isBoxChecked><span class="glyphicon glyphicon-erase"></span></button>
            <button type="button" class="btn btn-default" (click)="deleteFilter($event)" title="Filter löschen"><span class="glyphicon glyphicon-remove"></span></button>
            <span class="glyphicon" style="color: #333 !important; padding-left: 15px;" [ngClass]="{'glyphicon-chevron-down': advancedSearch?.isOpen, 'glyphicon-chevron-right': !advancedSearch?.isOpen}"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <div *ngIf="layout.getSourceNames().length === 0" style="text-align: center; margin-bottom: 5px;">
            Keine Suchattribute ausgewählt
          </div>
          <div *ngFor="let env of layout.getSourceNames()">
            <div *ngIf="layout.getConditions(env).length > 0">
              <span style="font-weight: bold;">{{mapSourceNameToName(env)}}</span>
              <table class="table table-bordered searchdefinition">
                <colgroup>
                  <col style="width: 17%;">
                  <col style="width: 17%;">
                  <col style="width: 5%;">
                  <col style="width: 58%;">
                  <col style="width: 3%;">
                </colgroup>
                <tr search-condition class="condition" *ngFor="let condition of layout.getConditions(env)"
                    [env]="env"
                    [condition]="condition"
                    [disabled]="!isBoxChecked"
                    [selectedEnvs]="selectedEnvironments"
                    (onRemove)="removeCondition($event)">
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </accordion-group>
  <accordion-group [isOpen]="isSearchResultsOpen" #searchResults>
    <div accordion-heading class="thinheader">
      <div class="row">
        <div class="col-xs-9">
          <div class="pull-left">
            Ergebnisse &nbsp;&nbsp;
            <mdm-view (click)="onViewClick($event)"></mdm-view>
          </div>
        </div>
        <div class="col-xs-3 pull-right">
          <div class="pull-right">
            <button type="button" class="btn btn-default" title="Selection to basket" (click)="selected2Basket($event)">
              <span class="glyphicon glyphicon-shopping-cart" style="color:#DADADA; margin-right: -12px;"></span>
              <span class="glyphicon glyphicon-shopping-cart" style="color:#A8A4A4; margin-right: -12px;"></span>
              <span class="glyphicon glyphicon-shopping-cart"></span>
            </button>
            <span class="glyphicon" [ngClass]="{'glyphicon-chevron-down': searchResults?.isOpen, 'glyphicon-chevron-right': !searchResults?.isOpen}" style="padding-left: 15px;"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row">
          <mdm-tableview [results]="results" [view]="viewComponent.selectedView" isShopable="true" [menuItems]="contextMenuItems">
          </mdm-tableview>
      </div>
    </div>
  </accordion-group>
</accordion>

<div bsModal #lgSaveModal="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="SelectSearchComponents" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" (click)="childSaveModal.hide()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Filter speichern als:</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
            <input type="text" class="form-control" placeholder="Filter-Name" [value]="filterName" (input)="filterName = $event.target.value" (keyup.enter)="saveFilter($event)">
          </div>
          <div class="row" style="margin-top: 10px;">
            <div class="col-md-12">
              <form class="form-inline">
                <button type="button" class="btn btn-default pull-right" (click)="saveFilter($event)" [disabled]="!filterName" title="{{filterName? '' : 'Name nicht gesetzt!'}}">
                  <span class="glyphicon glyphicon-floppy-disk"></span> Speichern
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<edit-searchFields [searchAttributes]="allSearchAttributesForCurrentResultType" [environments]="selectedEnvironments"></edit-searchFields>
<overwrite-dialog></overwrite-dialog>
